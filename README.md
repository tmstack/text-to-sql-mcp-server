# Text-to-SQL MCP æœåŠ¡å™¨

ä¸€ä¸ªåŸºäº FastMCP æ¡†æ¶çš„å®‰å…¨æ•°æ®åº“æŸ¥è¯¢æœåŠ¡ï¼Œç”¨äºæ•°æ®åº“æŸ¥è¯¢å’Œåˆ†æã€‚

## ğŸš€ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª MCP (Model Context Protocol) æœåŠ¡å™¨ï¼Œä¸“é—¨ç”¨äºæä¾›å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢æœåŠ¡ã€‚å®ƒåŸºäº FastMCP æ¡†æ¶æ„å»ºï¼Œæ”¯æŒ MySQL æ•°æ®åº“è¿æ¥ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„æƒé™ç®¡ç†å’Œå®‰å…¨æ§åˆ¶æœºåˆ¶ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

- **æ•°æ®åº“è¿æ¥ç®¡ç†**: å®‰å…¨çš„ MySQL æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢
- **æƒé™è®¤è¯**: åŸºäº RSA å¯†é’¥å¯¹çš„ Bearer Token è®¤è¯
- **å®‰å…¨æŸ¥è¯¢**: é˜²æ­¢ SQL æ³¨å…¥å’Œå±é™©æ“ä½œçš„å®‰å…¨æ£€æŸ¥
- **è¡¨ç»“æ„æŸ¥è¯¢**: è·å–æ•°æ®åº“è¡¨åˆ—è¡¨å’Œè¡¨ç»“æ„ä¿¡æ¯
- **SQL æ‰§è¡Œ**: å®‰å…¨çš„ SQL æŸ¥è¯¢æ‰§è¡Œï¼Œæ”¯æŒç»“æœé™åˆ¶
- **å¥åº·æ£€æŸ¥**: æœåŠ¡çŠ¶æ€ç›‘æ§
- **æƒé™ç®¡ç†**: ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Python 3.x**: ä¸»è¦ç¼–ç¨‹è¯­è¨€
- **FastMCP**: MCP æœåŠ¡å™¨æ¡†æ¶
- **MySQL**: æ•°æ®åº“ç³»ç»Ÿ
- **uvicorn**: ASGI æœåŠ¡å™¨
- **python-dotenv**: ç¯å¢ƒå˜é‡ç®¡ç†

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### ä¾èµ–åŒ…è¯´æ˜

python >=3.10

- `fastmcp==2.10.6`: MCP æœåŠ¡å™¨æ¡†æ¶
- `python-dotenv==1.1.0`: ç¯å¢ƒå˜é‡åŠ è½½
- `mysql-connector-python==8.2.0`: MySQL æ•°æ®åº“è¿æ¥å™¨
- `uvicorn==0.24.0`: ASGI æœåŠ¡å™¨

## âš™ï¸ é…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®

å¤åˆ¶ `.env.example` æ–‡ä»¶ä¸º `.env` å¹¶é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=your_database

# å¯é€‰ï¼šæœåŠ¡å™¨é…ç½®
MCP_HOST=127.0.0.1
MCP_PORT=8000
```

### 2. æ•°æ®åº“åˆå§‹åŒ–

ä½¿ç”¨æä¾›çš„ `dataset.sql` æ–‡ä»¶åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®ï¼š

```bash
mysql -u your_username -p your_database < dataset.sql
```

è¯¥æ–‡ä»¶åŒ…å«äº†ä¸€ä¸ª `contracts` è¡¨çš„ç¤ºä¾‹æ•°æ®ï¼ŒåŒ…å«åˆåŒä¿¡æ¯ã€‚

## ğŸš€ å¯åŠ¨æœåŠ¡

```bash
python mcp_server.py
```

æœåŠ¡å¯åŠ¨åä¼šæ˜¾ç¤ºï¼š

```
Authorization=Bearer ...
ğŸš€ å¯åŠ¨MCPæ•°æ®æŸ¥è¯¢æœåŠ¡å™¨...
ğŸ“ åœ°å€: http://127.0.0.1:8000
ğŸ“‹ å¯ç”¨å·¥å…·:
   - health_check: å¥åº·æ£€æŸ¥
   - get_user_permissions: è·å–ç”¨æˆ·æƒé™
   - get_database_tables: è·å–æ•°æ®åº“è¡¨åˆ—è¡¨
   - get_table_structure: è·å–è¡¨ç»“æ„
   - execute_sql_query: æ‰§è¡ŒSQLæŸ¥è¯¢
   - generate_sql_from_question: è‡ªç„¶è¯­è¨€ç”ŸæˆSQL
   - analyze_query_result: æŸ¥è¯¢ç»“æœåˆ†æ
```

## MCPå®¢æˆ·ç«¯é…ç½®
![config-example](config-example.png)

## ğŸ”§ API å·¥å…·

### 1. å¥åº·æ£€æŸ¥
- **å·¥å…·å**: `health_check`
- **æè¿°**: æ£€æŸ¥æœåŠ¡å’Œæ•°æ®åº“è¿æ¥çŠ¶æ€
- **æƒé™**: æ— éœ€ç‰¹æ®Šæƒé™

### 2. è·å–ç”¨æˆ·æƒé™
- **å·¥å…·å**: `get_user_permissions`
- **æè¿°**: è·å–å½“å‰ç”¨æˆ·çš„æƒé™ä¿¡æ¯
- **æƒé™**: éœ€è¦æœ‰æ•ˆçš„è®¿é—®ä»¤ç‰Œ

### 3. è·å–æ•°æ®åº“è¡¨åˆ—è¡¨
- **å·¥å…·å**: `get_database_tables`
- **æè¿°**: è·å–æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„åˆ—è¡¨
- **æƒé™**: éœ€è¦ `data:read_tables` æƒé™

### 4. è·å–è¡¨ç»“æ„
- **å·¥å…·å**: `get_table_structure`
- **å‚æ•°**: 
  - `table_name` (string): è¡¨å
- **æè¿°**: è·å–æŒ‡å®šè¡¨çš„ç»“æ„ä¿¡æ¯ã€è¡Œæ•°å’Œæ ·æœ¬æ•°æ®
- **æƒé™**: éœ€è¦ `data:read_tables` æƒé™

### 5. æ‰§è¡Œ SQL æŸ¥è¯¢
- **å·¥å…·å**: `execute_sql_query`
- **å‚æ•°**:
  - `sql_query` (string): SQL æŸ¥è¯¢è¯­å¥
  - `limit` (int, å¯é€‰): è¿”å›ç»“æœçš„æœ€å¤§è¡Œæ•°ï¼Œé»˜è®¤ 100
- **æè¿°**: å®‰å…¨æ‰§è¡Œ SQL æŸ¥è¯¢
- **æƒé™**: éœ€è¦ `data:read_table_data` æƒé™
- **å®‰å…¨é™åˆ¶**: ç¦æ­¢æ‰§è¡Œ DROP, DELETE, UPDATE, INSERT ç­‰ä¿®æ”¹æ“ä½œ

## ğŸ” å®‰å…¨ç‰¹æ€§

### æƒé™ç³»ç»Ÿ
- åŸºäº RSA å¯†é’¥å¯¹çš„ JWT Token è®¤è¯
- ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼š
  - `data:read_tables`: è¯»å–è¡¨ç»“æ„æƒé™
  - `data:read_table_data`: è¯»å–è¡¨æ•°æ®æƒé™

### å®‰å…¨æ£€æŸ¥
- **SQL æ³¨å…¥é˜²æŠ¤**: ç¦æ­¢å±é™©çš„ SQL æ“ä½œ
- **æŸ¥è¯¢é™åˆ¶**: è‡ªåŠ¨æ·»åŠ  LIMIT é™åˆ¶ï¼Œé˜²æ­¢å¤§é‡æ•°æ®æŸ¥è¯¢
- **æ•æ„Ÿæ•°æ®ä¿æŠ¤**: å¯¹åŒ…å«æ•æ„Ÿå…³é”®è¯çš„æŸ¥è¯¢è¿›è¡Œé¢å¤–æƒé™æ£€æŸ¥

## ğŸ“ é¡¹ç›®ç»“æ„

```
text-to-sql-mcp/
â”œâ”€â”€ mcp_server.py          # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”œâ”€â”€ database.py            # æ•°æ®åº“ç®¡ç†æ¨¡å—
â”œâ”€â”€ auth_token.py          # è®¤è¯ä»¤ç‰Œç”Ÿæˆæ¨¡å—
â”œâ”€â”€ requirements.txt       # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ dataset.sql           # ç¤ºä¾‹æ•°æ®åº“ç»“æ„å’Œæ•°æ®
â””â”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
```

## ğŸ” æ ¸å¿ƒæ¨¡å—è¯´æ˜

`mcp_server.py` ä¸»æœåŠ¡å™¨æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- MCP æœåŠ¡å™¨åˆå§‹åŒ–
- æ‰€æœ‰ API å·¥å…·çš„å®šä¹‰
- æƒé™éªŒè¯é€»è¾‘
- å®‰å…¨æ£€æŸ¥æœºåˆ¶

`database.py` æ•°æ®åº“ç®¡ç†æ¨¡å—ï¼Œæä¾›ï¼š
- MySQL æ•°æ®åº“è¿æ¥ç®¡ç†
- SQL æŸ¥è¯¢æ‰§è¡Œ
- è¡¨ç»“æ„ä¿¡æ¯è·å–
- æ•°æ®ç±»å‹è½¬æ¢

`auth_token.py` è®¤è¯æ¨¡å—ï¼Œè´Ÿè´£ï¼š
- RSA å¯†é’¥å¯¹ç”Ÿæˆ
- JWT è®¿é—®ä»¤ç‰Œåˆ›å»º
- è®¤è¯æä¾›è€…é…ç½®

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å®‰å…¨**: ç¡®ä¿æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–ï¼Œåªæˆäºˆå¿…è¦çš„æŸ¥è¯¢æƒé™
2. **ç½‘ç»œå®‰å…¨**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ HTTPS å’Œé˜²ç«å¢™ä¿æŠ¤
3. **ä»¤ç‰Œç®¡ç†**: å®šæœŸæ›´æ–°è®¿é—®ä»¤ç‰Œï¼Œé¿å…é•¿æœŸä½¿ç”¨åŒä¸€ä»¤ç‰Œ
4. **æŸ¥è¯¢ç›‘æ§**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼Œé¿å…å¤æ‚æŸ¥è¯¢å½±å“æ•°æ®åº“æ€§èƒ½

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## æˆ‘çš„ä½œå“
n8n å·¥ä½œæµè‡ªåŠ¨åŒ–æ¨¡ç‰ˆç«™ï¼Œæ”¶é›†äº†å¤§é‡å¯ç›´æ¥ä½¿ç”¨çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼šhttps://n8ntemplates.dev
